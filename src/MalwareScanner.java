import java.io.*;
import java.util.Map;
import java.util.Scanner;

/**
 * This class accomplishes Mission Firewall
 */
public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    /**
     * TODO: Open and read the input file while searching for threats
     * TODO: Write results to both; a new file name "scanLog.txt" and to the console
     *
     * @param filename the input file
     * @throws IOException the io exception
     */
    public void scanFile(String filename) throws IOException {
        // TODO: YOUR CODE HERE
        System.out.println("Started scanning...");
        System.out.println("--------------------------------------------------------------------------------");
        try {
            File file = new File(filename);
            Scanner myReader = new Scanner(file);
            PrintWriter writer = new PrintWriter("scanLog.txt", "UTF-8");

            int j = 1;
            int t = 0;
            while (myReader.hasNextLine()) {
                String data = myReader.nextLine();

                for(Map.Entry<String, Malware> e : malwareDB.entrySet()) {
                    String turboNumber = turbo64(data).toLowerCase();
                    String hashNumber = e.getValue().getHash().toLowerCase();
                    if(hashNumber.equals(turboNumber)) {
                        t++;
                        System.out.println("Detected malware!");
                        System.out.println("Name: " + e.getValue().getTitle());
                        System.out.println("Threat Level: " +  e.getValue().getLevel());
                        System.out.println("Hash:" + hashNumber);
                        System.out.println("--------------------------------------------------------------------------------");
                        String scanLog = hashNumber + "@" +  j;
                        writer.println(scanLog);
                    } }j++;
            }
            System.out.println("Scan complete! "+ t +" threats are found and eliminated. Generating log file...");
            myReader.close();
            writer.close();
        } catch (FileNotFoundException e) {
            System.out.println("An error occurred.");
            e.printStackTrace();
        }
    }
    public static String turbo64(String in) {

        long modTurbo = 4294967291L;
        long b = 1;
        long a = 0;
        for(char character: in.toCharArray()) {
            a = (a + (int) character) % modTurbo;
            b = (a + b) % modTurbo ;
        }
        long decimal = (b << 32) | a;
        return String.format("%02X", decimal) ;
    }
}
